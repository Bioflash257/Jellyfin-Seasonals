name: Auto Release Plugin

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'jellyfin.ruleset'
      - '.gitignore'
      - '.editorconfig'
      - 'LICENSE'
      - 'logo.png'
      - 'manifest.json'   # IMPORTANT: prevent infinite loop when we commit manifest updates
  workflow_dispatch: {}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Compute next version (1.8.0.X)
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          CURRENT=$(jq -r '.[0].versions[0].version' manifest.json)
          # BASE = first 3 parts: 1.8.0 from 1.8.0.0
          BASE=$(echo "$CURRENT" | awk -F. '{print $1"."$2"."$3}')
          BASE_TAG="v${BASE}.0"

          git fetch --tags --force

          if git rev-parse -q --verify "refs/tags/${BASE_TAG}" >/dev/null; then
            REV=$(git rev-list --count "${BASE_TAG}..HEAD")
          else
            REV=1
          fi

          # If you're exactly on the tag commit, REV becomes 0; force at least 1
          if [ "${REV}" -lt 1 ]; then REV=1; fi

          VERSION="${BASE}.${REV}"

          echo "CURRENT=$CURRENT"
          echo "BASE=$BASE"
          echo "BASE_TAG=$BASE_TAG"
          echo "REV=$REV"
          echo "VERSION=$VERSION"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BASE=$BASE" >> $GITHUB_ENV
          echo "REV=$REV" >> $GITHUB_ENV

          TARGET_ABI=$(jq -r '.[0].versions[0].targetAbi' manifest.json)
          PLUGIN_GUID=$(jq -r '.[0].guid' manifest.json)
          echo "TARGET_ABI=$TARGET_ABI" >> $GITHUB_ENV
          echo "PLUGIN_GUID=$PLUGIN_GUID" >> $GITHUB_ENV

          CHANGELOG=$(git log -1 --pretty=format:"%s (%h)")
          echo "CHANGELOG=$CHANGELOG" >> $GITHUB_ENV

      - name: Stop if tag already exists
        shell: bash
        run: |
          set -euo pipefail
          TAG="v${{ env.VERSION }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists. Nothing to do."
            exit 0
          fi

      - name: Build and Zip
        shell: bash
        run: |
          set -euo pipefail

          dotnet build Jellyfin.Plugin.Seasonals/Jellyfin.Plugin.Seasonals.csproj \
            --configuration Release \
            --output bin/Publish \
            /p:Version=${{ env.VERSION }} \
            /p:AssemblyVersion=${{ env.VERSION }} \
            /p:FileVersion=${{ env.VERSION }} \
            /p:InformationalVersion=${{ env.VERSION }}

          cd bin/Publish
          zip -r Jellyfin.Plugin.Seasonals.zip .
          cd ../..

          HASH=$(md5sum bin/Publish/Jellyfin.Plugin.Seasonals.zip | awk '{ print $1 }')
          TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "ZIP_HASH=$HASH" >> $GITHUB_ENV
          echo "BUILD_TIME=$TIME" >> $GITHUB_ENV
          echo "ZIP_PATH=bin/Publish/Jellyfin.Plugin.Seasonals.zip" >> $GITHUB_ENV

      - name: Update manifest.json (prepend new version)
        shell: bash
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          VERSION="${{ env.VERSION }}"
          DOWNLOAD_URL="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/v$VERSION/Jellyfin.Plugin.Seasonals.zip"
          jq --arg ver "$VERSION" \
             --arg changelog "${{ env.CHANGELOG }}" \
             --arg abi "${{ env.TARGET_ABI }}" \
             --arg url "$DOWNLOAD_URL" \
             --arg hash "${{ env.ZIP_HASH }}" \
             --arg time "${{ env.BUILD_TIME }}" \
             '.[0].versions = ([{
                "version": $ver,
                "changelog": $changelog,
                "targetAbi": $abi,
                "sourceUrl": $url,
                "checksum": $hash,
                "timestamp": $time
            }] + .[0].versions)' \
            manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json

      - name: Commit manifest.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update manifest.json for v${{ env.VERSION }}"
          file_pattern: manifest.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "v${{ env.VERSION }}"
          body: "${{ env.CHANGELOG }}"
          files: ${{ env.ZIP_PATH }}
          draft: false
          prerelease: false
          generate_release_notes: false
